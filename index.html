<html>
<head>
    <title>Reader Test</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script language="JavaScript">
        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition
        var SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList
        var SpeechRecognitionEvent = SpeechRecognitionEvent || webkitSpeechRecognitionEvent
        var focused = true;

        readingState = {
            'wordCount': 0,
            'currentWord': ''   // TODO: Kill this
        };

        function log(msg) {
            console.log(new Date().toUTCString() + " " + msg);
        }

        $(document).ready(function() {
            readingState.storyBox = $('#story');
            const text = readingState.storyBox.text().trim();
            readingState.storyBox.text('');
            const lines = text.split('\n');
            lines.forEach((line, i) => {
                if (line.trim().length > 0 ) {
                    const words = line.split(' ');
                    const li = $("<li class='line'></li>");
                    words.forEach(word => {
                        if (word.trim().length > 0) {
                            li.append("<span>"+word+" </span>");    
                        }
                    });                    
                    readingState.storyBox.append(li);
                }
            });
            readingState.allWords = readingState.storyBox.find('span');
            readingState.wordCount = readingState.allWords.length;
            highlightNextWord();
        });

        function highlightNextWord() {
            const word = unreadWordFromIndex();
            readingState.currentWord = word.str; // TODO: kill this

            unreadWordFromIndex().elem.addClass('current-word');
            listenForCurrentWord();
        }

        function unreadWordFromIndex() {
            return unreadWordsFromIndex(1)[0];
        }

        function unreadWordsFromIndex(count) {
            const unreadWords = readingState.storyBox.find('span:not(.read-word)');
            
            const selectedWordElms = unreadWords.slice(0, count);
            const result = new Array();

            const currentWordElm = selectedWordElms.each(function() {
                const currentWord = $(this).text();
                const re = RegExp(/(\w+)/g);
                const cleanWord = re.exec(currentWord)[1].toLowerCase();
                result.push({'elem': $(this), 'str': cleanWord});
            });            
            return result;
        }

        function onWordIdentified(event) {
            // Lets work out what we heard, and sanitize it.
            const results = event.results;
            const last_result_index = results.length -1;
            const last_result = results[last_result_index];
            const final = last_result.isFinal;
            const transcript = last_result[0].transcript.toLowerCase();
            const words = transcript.split(' ');
            const word = words[0];
            const confidence = last_result[0].confidence;
            log('++ Result received: "' + transcript + '" while looking for '+readingState.currentWord+'.' + '  Confidence: ' + confidence);

            // Words from the book (same number we think we heard spoken).
            const pageWords = unreadWordsFromIndex(words.length);

            // Word Previewing 
            readingState.storyBox.find('.heard-word').removeClass('heard-word');
            if (final) {
                // Clear current word
                readingState.storyBox.find('.current-word').removeClass('current-word');

                // We use a normal for loop, so we can break out, we only want to read words after a mistake
                for (let i = 0; i < words.length; ++i) {
                    if (pageWords[i].str == words[i]) {
                        pageWords[i].elem.addClass('read-word');
                    } else {
                        break;
                    }
                }

                highlightNextWord();
            } else {
                // Word Previewing, we will highlight any that match, even if not contiguous 
                words.forEach((w, i) => {
                    if (pageWords[i].str == w) {
                        pageWords[i].elem.addClass('heard-word');
                    }
                });
            }
        }
        
        
        var hidden, visibilityState, visibilityChange;

        if (typeof document.hidden !== "undefined") {
            hidden = "hidden", visibilityChange = "visibilitychange", visibilityState = "visibilityState";
        } else if (typeof document.msHidden !== "undefined") {
            hidden = "msHidden", visibilityChange = "msvisibilitychange", visibilityState = "msVisibilityState";
        }

        var document_hidden = document[hidden];

        document.addEventListener(visibilityChange, function() {
            if (document.hasFocus()) {
                listenForCurrentWord();
            }
        });

        function listenForCurrentWord() {
            if (!document.hasFocus()) return;

            // We can add Grammer but it doesn't seam to make any difference
            const grammar = '#JSGF V1.0; grammar words; public <word> = '+readingState.currentWord+' ;';
            
            const speechRecognitionList = new SpeechGrammarList();
            speechRecognitionList.addFromString(grammar, 1);

            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-GB'; //'en-US';
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
            //recognition.stop();
            recognition.grammars = speechRecognitionList;
            recognition.onresult = onWordIdentified;

            recognition.onaudioend = function() {
                log('Audio capturing ended');
                setTimeout(listenForCurrentWord, 0);
            }
            recognition.onaudiostart = function() {
                log('Audio capturing started');
            }
            recognition.onnomatch = function(event) {
                diagnostic.textContent = 'I didnt recognise that.';
            }

            recognition.start();
        }

    </script>
    <style>
        body {
            background-color: black;
            color: rgb(88,88,150);
            font-family: oda,comic sans ms,sans-serif;
            font-size: x-large;
        }
        .current-word {
            color: rgb(245, 66, 212);
        }        
        .read-word {
            color: cornflowerblue;
        }        
        .heard-word {
            border-bottom-color: rgb(245, 66, 212);
            border-bottom-style: dashed;
            border-bottom-width: thin;
        }
    </style>
</head>
<body>
    <!-- https://www.freechildrenstories.com/the-great-hill -->
    <div id="story">
The Bears spent their entire lives climbing the Great Hill, trying to reach the top.

Before time was time, there was a Great Hill. 

And on the Great Hill there lived the Bears.

The Bears spent their entire lives climbing the Great Hill, trying to reach the top.




Some Bears climbed fast.

Some Bears climbed slowly.

One Yolk in particular was a very slow climber. He was different than the rest of the Bears.
</div>

</body>
</html>
